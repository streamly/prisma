<!DOCTYPE html>
<html>
<head>
  <title>Bizilla TV - Auth</title>
  <link rel="stylesheet" href="/styles/auth.css">
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_live_Y2xlcmsuc3luZGluZXQuY29tJA"
    src="https://clerk.syndinet.com/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
    type="text/javascript"
  ></script>
</head>
<body>
  <p>Authenticating...</p>

  <script>
    window.addEventListener("load", async () => {
      try {
        await Clerk.load();

        // Get the active session
        const session = Clerk.session;
        if (!session) {
          console.log("No active session found, redirecting to dashboard");
          window.location.href = '/dev/index.html';
          return;
        }

        // Get session token
        const sessionToken = await session.getToken();
        
        // Get user information
        const user = Clerk.user;
        const userId = user.id;
        const fullName = user.fullName;
        const email = user.emailAddress;

        // Send sessionToken to backend for verification
        const resp = await fetch('/api/auth', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionToken}`
          },
          body: JSON.stringify({ 
            userId,
            fullName,
            email
          })
        });

        const data = await resp.json();

        if (data.authenticated) {
          console.log('Authentication successful, redirecting to dashboard...');
          window.location.href = '/dev/index.html';
        } else {
          console.error('Authentication failed:', data.error);
          window.location.href = '/dev/index.html';
        }

      } catch (err) {
        console.error("Authentication error:", err);
        window.location.href = '/dev/index.html';
      }
    });
  </script>
</body>
</html>