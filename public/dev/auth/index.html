<!DOCTYPE html>
<html>

<head>
  <title>SyndiNet - Auth</title>
  <link rel="icon" type="image/jpeg" href="/favicon.jpg">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f8f9fa;
      color: #333;
    }

    p {
      font-size: 1.1rem;
      color: #666;
    }
  </style>
  <script async crossorigin="anonymous" data-clerk-publishable-key="pk_live_Y2xlcmsuc3luZGluZXQuY29tJA"
    src="https://clerk.syndinet.com/npm/@clerk/clerk-js@5/dist/clerk.browser.js" type="text/javascript">
    </script>
</head>

<body>
  <div id="auth-container">
    <p>Loading authentication...</p>
  </div>

  <script>
    window.addEventListener("load", async () => {
      try {
        // Load Clerk
        await Clerk.load()

        const session = Clerk.session
        if (!session) {
          console.log("No active session found, redirecting to sign-in")
          Clerk.redirectToSignIn({ redirectUrl: window.location.href })
          return
        }

        // Get session token
        const sessionToken = await session.getToken()

        // Get user info
        const user = Clerk.user
        const userId = user.id
        const fullName = user.fullName
        const email = user.emailAddress

        // Send token to backend for verification
        const response = await fetch('/api/auth', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${sessionToken}`
          },
          body: JSON.stringify({ userId, fullName, email }),
          credentials: 'include' // ensure backend cookies are set
        })

        const data = await response.json()

        if (data.authenticated) {
          console.log('Authentication successful, redirecting...')
          window.location.href = '/dev/index.html'
        } else {
          console.error('Authentication failed:', data.error)
          window.location.href = '/dev/index.html'
        }

      } catch (error) {
        console.error('Authentication error:', error)
        window.location.href = '/dev/index.html'
      }
    });
  </script>
</body>

</html>