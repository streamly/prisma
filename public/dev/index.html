<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SyndiNet</title>
  <link rel="icon" type="image/jpeg" href="/favicon.jpg">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.css@8.2.1/themes/satellite-min.css"
    crossorigin="anonymous">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.11.8/video-js.min.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.2/mdb.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.23.3/dist/algoliasearch-lite.umd.js"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.68.1/dist/instantsearch.production.min.js"
    crossorigin="anonymous"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/typesense-instantsearch-adapter@2/dist/typesense-instantsearch-adapter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.11.8/video.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/parsley.js/2.9.2/parsley.min.js"></script>

  <!-- Clerk-->
  <script defer crossorigin="anonymous" data-clerk-publishable-key="pk_live_Y2xlcmsuc3luZGluZXQuY29tJA"
    src="https://clerk.syndinet.com/npm/@clerk/clerk-js@5/dist/clerk.browser.js" type="text/javascript"></script>

  <link href="/styles/dev.css" rel="stylesheet">
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg nav-icons bg-white fixed-top shadow-sm">
    <div class="container-fluid">
      <!-- Left section -->
      <div class="d-flex align-items-center ps-5">


        <a class="me-4" href="/dev">
          <img src="/dev/syndinet-sm.jpg" height="40" class="" title="SyndiNet">
        </a>

        <div id="searchbox" style="width:300px;"></div>
      </div>

      <!-- Right section -->
      <div class="d-flex align-items-center pe-5 ms-auto">
        <a class="btn btn-link bg-transparent p-0 m-0 add" role="button" type="button" title="Add a Video"
          href="/dev/upload"><i class="bx bx-plus bx-sm mx-4"></i></a>
        <a class="btn btn-link bg-transparent p-0 m-0 analytics" role="button" type="button" title="Analytics"><i
            class="bx bx-bar-chart bx-sm mx-4"></i></a>
        <a class="btn btn-link bg-transparent p-0 m-0 conversions" button type="button" title="Conversions"><i
            class="bx bx-user-voice bx-sm mx-4"></i></a>

        <div class="dropdown">
          <a class="btn btn-link bg-transparent p-0 m-0" href="#" title="More" data-mdb-toggle="dropdown"
            aria-expanded="false">
            <i class="bx bx-dots-vertical-rounded bx-sm mx-4"></i>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a type="button" class="dropdown-item billing">Billing</a></li>
            <li><a type="button" class="dropdown-item profile">Profile</a></li>
            <li><a type="button" class="dropdown-item help">Help</a></li>
            <li><a type="button" class="dropdown-item logout">Sign Out</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>


  <!-- content -->
  <div class="container-fluid p-4 mb-5 ">
    <div class="row">
      <div class="col-2">
        <h5 class="btn btn-link btn-sm disabled text-dark mt-4 mb-0">Company</h5>
        <div id="channel-filter" class="ps-2"></div>

        <h5 class="btn btn-link btn-sm disabled text-dark mt-4 mb-0">Duration</h5>
        <div id="duration-filter" class="ps-2"></div>

        <h5 class="btn btn-link btn-sm disabled text-dark mt-4 mb-0">Date Added</h5>
        <div id="created-filter" class="ps-2 mb-5"></div>
        <div class="p-5 m-5"></div>
        <div id="refinements" style="display:none;"></div>
      </div>
      <div class="col p-0">
        <div id="hits" class=""></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="small m-0 p-0 text-center small text-muted">
    &copy; <span id="year"></span> SyndiNet. All rights reserved. &bull;
    <a href="terms.html" target="_window">Terms of Service</a> &bull;
    <a href="privacy.html" target="_window">Privacy Policy</a>

    <script>
      document.getElementById("year").textContent = new Date().getFullYear();
    </script>
  </footer>


  <!-- vodModal -->
  <div class="modal fade" id="vodModal" tabindex="-1" aria-labelledby="vodModalLabel" aria-hidden="true"
    style="z-index:99999999 !important;">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title d-flex align-items-center"><i class="bx bx-tv lead me-2"></i><span
              class="modal-video-title">Metadata</span></h5>
          <button type="button" class="btn-close" data-mdb-ripple-init data-mdb-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body px-5 py-4">


          <div class="row">
            <div class="col-9 small pe-2 pb-4">

              <div class="mb-3">
                <video id="player" controls preload="auto" data-setup="{}"
                  class="video-js vjs-default-skin vjs-big-play-centered vjs-16-9 bg-dark w-100 border "></video>
              </div>

              <!-- MODAL FORM -->
              <form id="vod" data-parsley-validate>
                <input type="hidden" name="id" id="id" equired />

                <div class="mb-3">
                  <label for="title">Title</label>
                  <input id="title" type="text" name="title" required maxLength="150"
                    class="form-control text-trim border validate" />
                </div>

                <!-- FIELD - CATEGORY -->
                <div class="mb-3">
                  <label for="type">Category</label>
                  <select id="category" name="category[]" required class="form-control text-trim border validate">
                    <option>
                    <option value="Animation">Animation</option>
                    <option value="Annual Report">Annual Report</option>
                    <option value="Behind-The-Scenes">Behind-The-Scenes</option>
                    <option value="Board Meeting Highlights">Board Meeting Highlights</option>
                    <option value="Brand">Brand</option>
                    <option value="Case Study">Case Study</option>
                    <option value="Client Testimonial">Client Testimonial</option>
                    <option value="Company Culture">Company Culture</option>
                    <option value="Company Profile">Company Profile</option>
                    <option value="Corporate Finance">Corporate Finance</option>
                    <option value="Corporate Social Responsibility">Corporate Social Responsibility</option>
                    <option value="Crowdfunding / Fundraising">Crowdfunding / Fundraising</option>
                    <option value="Event">Event</option>
                    <option value="Explainer">Explainer</option>
                    <option value="Financial Report">Financial Report</option>
                    <option value="Internal Communication">Internal Communication</option>
                    <option value="Investor Relations">Investor Relations</option>
                    <option value="Marketing Campaign">Marketing Campaign</option>
                    <option value="Onboarding">Onboarding</option>
                    <option value="Product">Product</option>
                    <option value="Product Launch">Product Launch</option>
                    <option value="Promotional">Promotional</option>
                    <option value="Quarterly Results">Quarterly Results</option>
                    <option value="Recruitment / Hiring">Recruitment / Hiring</option>
                    <option value="Sales Pitch">Sales Pitch</option>
                    <option value="Social Media">Social Media</option>
                    <option value="Strategy / Planning">Strategy / Planning</option>
                    <option value="Talent Profile">Talent Profile</option>
                    <option value="Testimonial">Testimonial</option>
                    <option value="Training">Training</option>
                    <option value="Tutorial">Tutorial</option>
                    <option value="Vision & Mission">Vision & Mission</option>
                    <option value="Webinar">Webinar</option>
                    <option value="Workshop">Workshop</option>
                  </select>
                </div>

                <!-- FIELD - AUDIENCE -->
                <div class="mb-3">
                  <label for="audience">Audience</label>
                  <select id="audience" name="audience" required class="form-control text-trim border validate">
                    <option value="">Select an audience</option>
                    <option value="Business">Business</option>
                    <option value="Consumer">Consumer</option>
                    <option value="Government">Government</option>
                    <option value="NGO/Non-Profit">NGO/Non-Profit</option>
                  </select>
                </div>

                <!-- FIELD - DESCRIPTION -->
                <div class="mb-3">
                  <label for="description">Description</label>

                  <textarea id="description" name="description" rows="6" required maxLength="500"
                    class="form-control border text-trim validate"></textarea>
                </div>

                <!-- FIELD - COMPANY -->
                <div class="mb-3">
                  <label for="company">Company</label>

                  <div class="">
                    <div id="company-wrapper">
                      <div class="input-group mb-2 company-input">
                        <input id="company" type="text" name="company[]" required maxLength="40"
                          class="form-control text-trim border validate" />
                        <span class="input-group-text remove-company" style="cursor:pointer;">
                          <i class='bx bx-x'></i>
                        </span>
                      </div>
                    </div>
                    <!-- <button type="button" id="add-company"
                      class="btn btn-link btn-sm bg-transparent p-0 m-0 float-end">Add A Company</button> -->
                  </div>
                </div>

                <!-- FIELD - TAGS -->
                <div class="mb-3">
                  <label for="tags">Keywords</label>
                  <input id="tags" type="text" name="tags" required maxLength="100"
                    class="form-control border validate" />
                </div>

                <!-- FIELD - CPV, BUDGET -->
                <div class="performance" style="display:none;">
                  <div class="mb-3">
                    <label for="cpv" class="">CPV Bid (per minute) <i class='bx bx-help-circle'
                        title="Set a cost-per-view (CPV) bid of $0.05 per minute or higher to amplify your video's reach. Higher bids elevate your content in recommendations, driving greater visibility, engagement, and conversions."></i>
                    </label>
                    <input type="text" id="cpv" name="cpv" value="0" data-parsley-min="0.05" required
                      class="form-control bg-white border validate" />
                  </div>
                  <div class="mb-3">
                    <label for="budget" class="">Daily Spend Limit <i class='bx bx-help-circle'
                        title="Set your daily spending limit tp cover at least 10 full-length plays. Once it's reached, your content's distribution will pause until the next day. Slight overages may occur due to brief delays in updating search recommendations."></i>
                    </label>
                    <input type="text" id="budget" name="budget" value="0" data-parsley-min="1" required
                      class="form-control bg-white border validate" />
                  </div>
                </div>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" value="" id="performance" xdisabled />
                  <label class="form-check-label" for="performance">Ad-free performance marketing</label>
                </div>

                <!-- SUBMIT BUTTON -->
                <button id="publish" data-active="1" type="button"
                  class="btn btn-dark shadow-none ms-0 me-4 px-4">Publish</button>
              </form>
            </div>

            <!-- THUMBNAIL -->
            <div class="col-3 pe-0">
              <!-- Image placeholder -->
              <div class="small pb-3">
                <div class="image-container">
                  <img id="thumbnail" class="img-fluid w-100 border" src="" height="169" title="Thumbnail"
                    style="display:none" />
                  <div class="overlay">
                    <div class="icon-container">
                      <a href="javascript:void(0);" title="Refresh" class="refresh">
                        <i class="bx bx-refresh icon" style="font-size:48px !important;"></i>
                      </a>
                    </div>
                  </div>
                </div>

                <canvas id="thumbnail-canvas" style="display:none;"></canvas>
                <button type="button" id="generate-thumbnail" data-optimizer="" data-uid="" data-id=""
                  class="btn btn-dark mb-3 shadow-none w-100 mt-3">
                  GENERATE THUMBNAIL
                </button>
                <button type="button" id="save-thumbnail" data-optimizer="" data-uid="" data-id=""
                  class="btn btn-dark mb-3 shadow-none w-100 mt-3">
                  SAVE THUMBNAIL
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- analyticsModal -->
  <div class="modal fade" id="analyticsModal" tabindex="-1" aria-labelledby="analyticsModalLabel" aria-hidden="true"
    style="z-index:99999999 !important;">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Analytics</h5>
          <button type="button" class="btn-close" data-mdb-ripple-init data-mdb-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">...</div>
      </div>
    </div>
  </div>

  <!-- conversionsModal -->
  <div class="modal fade" id="conversionsModal" tabindex="-1" aria-labelledby="conversionsModalLabel" aria-hidden="true"
    style="z-index:99999999 !important;">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Conversions</h5>
          <button type="button" class="btn-close" data-mdb-ripple-init data-mdb-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">...</div>
      </div>
    </div>
  </div>

  <!-- billingModal -->
  <div class="modal fade" id="billingModal" tabindex="-1" aria-labelledby="billingModalLabel" aria-hidden="true"
    style="z-index:99999999 !important;">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Billing</h5>
          <button type="button" class="btn-close" data-mdb-ripple-init data-mdb-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">...</div>
      </div>
    </div>
  </div>

  <!-- helpModal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true"
    style="z-index:99999999 !important;">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Help</h5>
          <button type="button" class="btn-close" data-mdb-ripple-init data-mdb-dismiss="modal"
            aria-label="Close"></button>
        </div>
        <div class="modal-body">...</div>
      </div>
    </div>
  </div>

  <!-- VIDEO DELETION MODAL -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete the video "<span id="videoTitleToDelete"></span>"?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // REDIRECT FOR UNSIGNED USERS
    window.addEventListener('DOMContentLoaded', async function () {
      await Clerk.load()

      if (!Clerk.user) {
        Clerk.redirectToSignIn({ redirectUrl: '/dev/auth/' })
        return
      }
    })

    $(document).on('click', '.dropdown-item.logout', async function (e) {
      e.preventDefault()

      await cookieStore.delete('uid', { path: '/' })
      await cookieStore.delete('apiKey', { path: '/' })

      await Clerk.signOut({ redirectUrl: '/dev' })
    })
  </script>

  <script>
    async function getClerkToken() {
      await Clerk.load()

      if (!Clerk.user) {
        throw new Error('Missing Clerk token')
      }

      return Clerk.session.getToken()
    }

    async function apiRequest(endpoint, method = 'POST', body = null) {
      const token = await getClerkToken()
      const options = {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
        }
      }

      if (body) {
        if (body instanceof FormData) {
          options.body = body
        } else {
          options.headers['Content-Type'] = 'application/json'
          options.body = JSON.stringify(body)
        }
      }

      try {
        const response = await fetch(endpoint, options)
        const data = await response.json()
        if (!response.ok || data.success === false) {
          throw new Error(data.error || 'Unknown API error')
        }
        return data
      } catch (err) {
        console.error(`API request failed: ${endpoint}`, err)
        throw err
      }
    }

    const player = videojs('player', {
      autoplay: false,
      muted: false,
      controls: true,
    })

    let isVideoUpdated = false
    let search

    window.addEventListener('DOMContentLoaded', async function () {
      // Add new company input
      $('#add-company').click(function () {
        const newInput = $('#company-wrapper .company-input:first').clone()
        newInput.find('input').val('') // clear value
        $('#company-wrapper').append(newInput)
        updateRemoveButtons()
      })

      // Remove company input
      $('#company-wrapper').on('click', '.remove-company', function () {
        if ($('#company-wrapper .company-input').length > 1) {
          $(this).closest('.company-input').remove()
        }
        updateRemoveButtons()
      })

      // Show/hide remove buttons if only 1 input left
      function updateRemoveButtons() {
        if ($('#company-wrapper .company-input').length === 1) {
          $('#company-wrapper .company-input .remove-company').hide()
        } else {
          $('#company-wrapper .company-input .remove-company').show()
        }
      }

      updateRemoveButtons()

      const apiKey = (await window.cookieStore.get('apiKey')).value

      if (!apiKey) {
        console.error('Typesense API key is missing')
        return // don't initialize the search
      }

      const now = new Date()
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() / 1000 // Start of today
      const yesterday = today - 86400 // Start of yesterday
      const startOfWeek = today - (now.getDay() * 86400) // Start of this week (Sunday)
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime() / 1000 // Start of this month


      const typesenseInstantsearchAdapter = new TypesenseInstantSearchAdapter({
        server: {
          apiKey: apiKey,
          nodes: [{ host: "t1.tubie.cx", port: 443, protocol: "https" }],
        },
        additionalSearchParameters: {
          query_by: "title,company,channel,description,tags",
          sort_by: "modified:desc"
        },
      })

      search = instantsearch({
        indexName: "videos",
        searchClient: typesenseInstantsearchAdapter.searchClient,
        routing: false,
        searchFunction(helper) {
          // Only scroll to the top for new searches (not when paging)
          if (helper.state.page === 0) { window.scrollTo({ top: 0, behavior: 'auto', }) }
          helper.search()
        },
      })

      search.addWidgets([
        instantsearch.widgets.searchBox({
          container: "#searchbox",
          placeholder: "Search",
          autofocus: true,
          showReset: true,
          showSubmit: true,
        }),

        instantsearch.widgets.refinementList({
          container: '#channel-filter',
          attribute: 'channel',
          searchable: true,
          searchablePlaceholder: 'Search companies',
          limit: 30,
          templates: {
            item(data) {
              return `<label><input type="checkbox" ${data.isRefined ? 'checked' : ''} /> ${decodeHTMLEntities(data.label)} (${data.count})</label>`
            }
          }
        }),

        instantsearch.widgets.numericMenu({
          container: '#duration-filter',
          attribute: 'duration',
          items: [
            { label: 'Any' },
            { label: 'Under 4 minutes', start: 1, end: 239 },
            { label: '4 - 20 minutes', start: 240, end: 1199 },
            { label: 'Over 20 minutes', start: 1200 },
          ],
        }),
        instantsearch.widgets.numericMenu({
          container: '#created-filter',
          attribute: 'created',
          items: [
            { label: 'All', start: 0 }, // No filter for "All"
            { label: 'Today', start: today }, // From the start of today
            { label: 'Yesterday', start: yesterday, end: today }, // From the start of yesterday to the end of yesterday
            { label: 'This Week', start: startOfWeek }, // From the start of the week
            { label: 'This Month', start: startOfMonth }, // From the start of the month
          ],
        }),
        instantsearch.widgets.currentRefinements({
          container: '#refinements',
          transformItems(items) {
            // Show/hide the clear button depending on refinements
            if (items.length > 0) {
              $("#clear").show()
            } else {
              $("#clear").hide()
            }
            return items
          }
        }),


        instantsearch.widgets.infiniteHits({
          container: "#hits",
          transformItems(items) {
            return items.map((item, index) => ({
              ...item,
              resultPosition: index + 1,
            }))
          },
          templates: {
            item(hit) {
              hit.position = hit.__position

              console.log('Hit', hit)
              console.dir(hit, { depth: null, colors: true })

              const dataAttributes = Object.keys(hit).map(key => {
                const safeKey = `data-${key.replace(/[^a-z0-9_-]/gi, '')}`
                let value = hit[key]
                if (Array.isArray(value)) value = value.join('; ')
                const safeValue = encodeURIComponent(String(value ?? ''))
                return `${safeKey}="${safeValue}"`
              }).join(' ')

              const title = decodeHTMLEntities(hit.title || "")
              const description = decodeHTMLEntities(hit.description || "")

              return `
<div 
  class="row border-0 bg-transparent mb-3" 
  ${dataAttributes} 
  type="button" 
  id="${hit.id}"
>
  <!-- Thumbnail (col-2) -->
  <div class="col-2 text-end">
    <div 
      class="edit pointer thumbnail-container bg-dark" 
      alt="${title}" 
      title="${title}"
    >
      <div 
        class="img-fluid border bg-dark thumbnail-background"
        style="
          height:69px;
          width:123px;
          background-repeat:no-repeat;
          background-size:cover;
          background-image:url('https://img.syndinet.com/${hit.id}');
        "
      >
      </div>
      <div class="duration">${formatDuration(hit.duration)}</div>
    </div>
  </div>

  <!-- Title + Channel (col) -->
  <div class="col">
    <h6 class="edit title-clamp m-0" title="${title}">
      ${title}
    </h6>
    <div class="edit pointer text-muted small text-truncate">
      ${Array.isArray(hit.channel) ? hit.channel.join("; ") : ""}
    </div>
    <div class="col-12 text-muted small mt-1">
      Modified: 
      ${hit.modified
                  ? new Date(hit.modified * 1000).toLocaleString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })
                  : 'undefined'
                }
      <br>
      <span class="text-secondary small">ID: ${hit.id}</span>
    </div>
  </div>

  <!-- Actions (col-1) -->
  <div class="col-1">
    <div class="dropdown">
      <a 
        class="btn btn-link bg-transparent p-0 m-0" 
        href="#" 
        title="More" 
        data-mdb-toggle="dropdown" 
        aria-expanded="false"
      >
        <i class="bx bx-dots-vertical-rounded bx-sm mx-4"></i>
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a type="button" class="dropdown-item edit">Edit</a></li>
        <li><a type="button" class="dropdown-item analytics">Analytics</a></li>
        <li><a type="button" class="dropdown-item conversions">Conversions</a></li>
        <li><a type="button" class="dropdown-item billing">Billing</a></li>
        <li><a type="button" class="dropdown-item delete">Delete</a></li>
      </ul>
    </div>
  </div>
</div>
        `
            },
          },
        }),
      ])

      search.start()

      const urlParams = new URLSearchParams(window.location.search)

      if (urlParams.get('v')) {
        const v = urlParams.get('v') // removed extra closing parenthesis
        search.helper
          .setQuery("")
          .setQueryParameter("filters", `id:${v}`)
          .search()

        setTimeout(function () {
          $("#vodModal").data("uploaded", 1)
          $(".edit").first().trigger("click")
        }, 1000)
      }

      $(document).on("click", "#reload", function (e) {
        search.helper.setQuery("").search()

      })

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
              const btn = entry.target
              if (!btn.disabled && btn.offsetParent !== null) {
                btn.click()
              }
            }
          })
        },
        { threshold: [0.5] }
      )

      const watchLoadMoreButton = () => {
        const btn = document.querySelector(".ais-InfiniteHits-loadMore")
        if (btn) {
          observer.observe(btn)
        } else {
          setTimeout(watchLoadMoreButton, 300)
        }
      }

      watchLoadMoreButton()
    })

    // edit
    $(document).on("click", ".edit", function () {
      const data = $(this).closest('.row').data()
      $("#vodModal .modal-video-title").text(decodeURIComponent(data.title))

      $("#id").val(decodeURIComponent(data.id || ''))
      $("#title").val(decodeURIComponent(data.title || ''))
      $("#description").val(decodeURIComponent(data.description || ''))

      // Single-select audience
      let audienceVal = Array.isArray(data.audience) ? decodeURIComponent(data.audience[0]) : decodeURIComponent(data.audience || '')
      $("#audience").val(audienceVal.trim())

      // Category (multi-select)
      let categoryVal = Array.isArray(data.category) ? data.category.map(v => decodeURIComponent(v)) : decodeURIComponent(data.category || '').split(';').map(v => v.trim()).filter(v => v)
      $("#category").val(categoryVal)

      // Company (single input)
      $("#company").val(decodeURIComponent(data.company || ''))

      // Tags
      $("#tags").val(decodeURIComponent(data.tags || ''))

      $("#cpv").val(data.cpv !== undefined ? decodeURIComponent(data.cpv) : 0)
      $("#budget").val(data.budget !== undefined ? decodeURIComponent(data.budget) : 0)
      $("#performance").prop("checked", data.cpv >= 0.05)
      $(".performance").toggle(data.cpv >= 0.05)

      const videoId = data.id

      $('#generate-thumbnail, #save-thumbnail').data('id', videoId)

      const newUrl = new URL(window.location.href)
      newUrl.searchParams.set('v', videoId)
      window.history.replaceState({}, '', newUrl)

      player.src({
        src: `https://cdn.tubie.cx/${data.id}/playlist.m3u8`,
        type: 'application/x-mpegURL'
      })

      console.log('Opened modal for', videoId)
      const modal = new mdb.Modal(document.getElementById("vodModal"))
      modal.show()
    })

    // performance
    $(document).on("click", "#performance", function () {
      $(".performance").toggle()
    })

    // update video
    $('#vod').parsley()
    $(document).on("click", "#publish", async function () {
      // Collect values
      const payload = {
        id: $("#id").val(),
        title: $("#title").val(),
        description: $("#description").val(),
        category: [$("#category").val()],
        audience: [$("#audience").val()],
        // company: $("#company-wrapper input").first().val(),
        company: $("#company").val(),
        tags: $("#tags").val().split(','),
        cpv: parseFloat($("#cpv").val()),
        budget: parseFloat($("#budget").val()),
        performance: $("#performance").is(":checked") ? 1 : 0,
        active: 1
      }

      try {
        console.log('Update payload', payload)
        const result = await apiRequest('/api/update', 'POST', payload)

        isVideoUpdated = true
        // search.helper.setQuery(search.helper.state.query).search()

        $(".btn-close").trigger("click")
      } catch (err) {
        alert("Request failed: " + err.message)
      }
    })

    // VIDEO DELETE

    let videoToDelete = null
    let videoTitleToDelete = null

    $(document).on("click", ".delete", function (e) {
      e.preventDefault()
      const data = $(this).closest('.row').data()
      videoToDelete = data.id
      videoTitleToDelete = decodeURIComponent(data.title || '')

      $("#videoTitleToDelete").text(videoTitleToDelete)

      const modal = new mdb.Modal(document.getElementById("confirmDeleteModal"))
      modal.show()
    })

    $(document).on("click", "#confirmDeleteBtn", async function () {
      if (!videoToDelete) return

      const token = await Clerk.session.getToken()

      try {
        const response = await fetch("/api/delete", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ id: videoToDelete }),
        })

        const result = await response.json()
        if (result.success) {
          location.reload()
        } else {
          alert("Error: " + result.error)
        }
      } catch (err) {
        alert("Request failed: " + err.message)
      } finally {
        videoToDelete = null
        const modal = mdb.Modal.getInstance(document.getElementById("confirmDeleteModal"))
        modal.hide()
      }
    })

    // analytics
    $(document).on("click", ".analytics", function () {
      const data = $(this).data()
      //$("#vodModal .modal-title").text( decodeURIComponent(data.title)  );
      const modal = new mdb.Modal(document.getElementById("analyticsModal"))
      modal.show()

    })

    // conversions
    $(document).on("click", ".conversions", function () {
      const data = $(this).data()
      //$("#vodModal .modal-title").text( decodeURIComponent(data.title)  );
      const modal = new mdb.Modal(document.getElementById("conversionsModal"))
      modal.show()

    })

    // billing
    $(document).on("click", ".billing", async function () {
      const data = $(this).data()

      const customerId = (await window.cookieStore.get('user_cus')).value

      try {
        const result = await apiRequest(customerId ? '/api/payments' : '/api/checkout')

        if (!result.url) {
          throw new Error('Failed to get redirect url')
        }

        window.location.href = result.url
      } catch (error) {
        console.error('Error fetching billing url', error)
        alert('Error:', error.message || 'Error fetching billing information')
      }
    })

    // help
    $(document).on("click", ".help", function () {
      const data = $(this).data()
      //$("#vodModal .modal-title").text( decodeURIComponent(data.title)  );
      const modal = new mdb.Modal(document.getElementById("helpModal"))
      modal.show()

    })

    // modal close
    $("#vodModal").on("hidden.bs.modal", function () {
      player.pause()
      $('.modal.show .btn-close, .offcanvas.show .btn-close').trigger('click')
      $(document).attr("title", "SyndiNet")

      const newUrl = new URL(window.location.href)
      newUrl.searchParams.delete('v')
      window.history.replaceState({}, '', newUrl)

      const uploaded = $(this).data('uploaded')


      if (isVideoUpdated) {
        isVideoUpdated = false

        window.location.reload()

        // #TODO Doesn't work for some reason 
        // if (search && search.refresh) {
        //   search.refresh()
        // } else if (search && search.helper) {
        //   search.helper.search()
        // }
      }
    })

    function formatDuration(seconds) {
      if (!seconds || isNaN(seconds)) return "0:00" // guard

      const hrs = Math.floor(seconds / 3600)
      const mins = Math.floor((seconds % 3600) / 60)
      const secs = Math.floor(seconds % 60)

      const formattedMins = mins < 10 ? "0" + mins : mins
      const formattedSecs = secs < 10 ? "0" + secs : secs

      if (hrs > 0) {
        return `${hrs}:${formattedMins}:${formattedSecs}`
      } else {
        return `${formattedMins}:${formattedSecs}`
      }
    }

    function decodeHTMLEntities(text) {
      const txt = document.createElement("textarea")
      txt.innerHTML = text
      return txt.value
    }

    // THUMBNAIL GENERATION

    var canvas = document.getElementById("thumbnail-canvas")
    let frameReady = false

    $("#vodModal").on("hidden.bs.modal", function () {
      frameReady = false
      canvas.style.display = 'none'
      $('#thumbnail').attr('src', '').hide()
      $('#generate-thumbnail').prop('disabled', true).addClass('disabled')
      $('#save-thumbnail').prop('disabled', true).addClass('disabled')
    })

    // Enable button once video has played a frame
    player.on('timeupdate', () => {
      if (!frameReady && player.currentTime() > 0) {
        frameReady = true
        console.log('First frame available - enabling thumbnail button')
        $('#generate-thumbnail').prop('disabled', false).removeClass('disabled')
      }
    })

    let generatedThumbnailUrl = null
    let generatedThumbnailBlob = null

    $('#generate-thumbnail').prop('disabled', true).addClass('disabled')

    $(document).on('click', '#generate-thumbnail', async function () {
      console.log("Generate thumbnail clicked")

      var id = $(this).data("id")
      var video = document.querySelectorAll("video")[0]

      // Set canvas size
      canvas.width = 300
      canvas.height = 169

      // Draw video frame on canvas
      canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height)

      generatedThumbnailUrl = canvas.toDataURL("image/jpeg", 0.9)

      canvas.toBlob(blob => {
        generatedThumbnailBlob = blob
      })

      $('#thumbnail').attr('src', generatedThumbnailUrl).show()
      $('#image-' + id).css({ "background-image": `url(${generatedThumbnailUrl})` })

      $('#save-thumbnail').prop('disabled', false).removeClass('disabled')
    })

    $('#save-thumbnail').prop('disabled', true).addClass('disabled')

    $(document).on('click', '#save-thumbnail', async function () {
      if (!generatedThumbnailBlob) {
        alert('You have to generate thumbnail first')
        return
      }

      const id = $(this).data("id")
      const formData = new FormData()
      formData.append('file', generatedThumbnailBlob, `${id}.jpg`)
      formData.append('id', id)

      console.log(formData)

      const token = await getClerkToken()

      try {
        const res = await fetch('/api/capture', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        })

        const result = await res.json()

        if (result.success) {
          isVideoUpdated = true

          $(".btn-close").trigger("click")
          alert('Thumbnail saved successfully!')

          const timestamp = new Date().getTime()
          const imgUrl = `https://img.syndinet.com/${id}?t=${timestamp}`

          $('#thumbnail').attr('src', imgUrl)
          $(`#image-${id}`).css("background-image", `url(${imgUrl})`)
          $(`.play[data-id="${id}"] .thumbnail-background`).css("background-image", `url(${imgUrl})`)

        } else {
          alert('Saving failed: ' + (result.error || 'Unknown error'))
        }
      } catch (error) {
        console.error('Error saving thumbnail', error)
        alert('Error saving thumbnail: ' + error.message)
      }
    });

  </script>
</body>

</html>