<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bizilla TV - Dashboard</title>
  <link rel="stylesheet" href="/styles/dashboard.css">

  <!-- Clerk JS SDK -->
  <script 
    async 
    crossorigin="anonymous" 
    data-clerk-publishable-key="pk_live_Y2xlcmsuc3luZGluZXQuY29tJA" 
    src="https://clerk.syndinet.com/npm/@clerk/clerk-js@5/dist/clerk.browser.js" 
    type="text/javascript">
  </script>
   <script src="https://cdn.jsdelivr.net/npm/typesense@2/dist/typesense.min.js"></script>
  
</head>
<body>
  <h1>Bizilla TV</h1>
  
  <div class="user-info">
    <p id="greeting">Loading user info...</p>
  </div>
  
  <div class="button-container">
    <button id="signInBtn" class="primary-btn">Sign In / Sign Up</button>
    <button id="uploadBtn" class="secondary-btn" style="display: none;">Upload Video</button>
    <button id="signOutBtn" class="danger-btn" style="display: none;">Sign Out</button>
  </div>

  <div class="videos-container" id="videosContainer" style="display: none;">
    <h2>Your Videos</h2>
    <div class="video-grid" id="videoGrid">
      <!-- Videos will be loaded here -->
    </div>
    <div class="no-videos" id="noVideos" style="display: none;">
      <h3>No videos found</h3>
      <p>Upload your first video to get started!</p>
    </div>
  </div>

  <!-- Video Details Modal -->
  <div id="videoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Video Details</h2>
        <span class="close" onclick="closeVideoModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="video-player-section">
          <div class="video-player" id="videoPlayer">
            <video controls style="width: 100%; height: 100%;" id="videoElement">
              <source src="" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
        </div>
        <div class="video-form">
          <form id="videoDetailsForm">
            <div class="form-group">
              <label for="videoTitle">Title</label>
              <input type="text" id="videoTitle" name="title" required>
            </div>
            <div class="form-group">
              <label for="videoDescription">Description</label>
              <textarea id="videoDescription" name="description" placeholder="Enter video description..."></textarea>
            </div>
            <div class="thumbnail-section">
              <label>Thumbnail</label>
              <div class="thumbnail-preview" id="thumbnailPreview" onclick="generateThumbnail()">
                <span>Click to generate thumbnail</span>
              </div>
              <input type="file" id="thumbnailInput" accept="image/*" style="display: none;" onchange="handleThumbnailUpload(event)">
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeVideoModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="publishVideo()">Publish</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration - UPDATE THESE VALUES
    const CONFIG = {
      TYPESENSE_HOST: '1.tubie.cx', // Replace with your Typesense host (hostname only, no protocol)
    };

    // Initialize Typesense client
    let typesenseClient = null;

    window.addEventListener('load', async function () {
      try {
        await Clerk.load();

        const session = Clerk.session;

        const greetingEl = document.getElementById('greeting');
        const signInBtn = document.getElementById('signInBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const videosContainer = document.getElementById('videosContainer');

        if (session) {
          // User is signed in
          const user = Clerk.user;
          greetingEl.innerHTML = `<strong>Hello, ${user.fullName}!</strong><br>You can now upload videos.`;
          signInBtn.style.display = 'none';
          uploadBtn.style.display = 'inline-block';
          signOutBtn.style.display = 'inline-block';
          videosContainer.style.display = 'block';
          
          // Load videos
          loadVideos();
        } else {
          // Not signed in
          greetingEl.textContent = "Please sign in to access your account.";
          signInBtn.style.display = 'inline-block';
          uploadBtn.style.display = 'none';
          signOutBtn.style.display = 'none';
          videosContainer.style.display = 'none';
        }

      // Sign In button
      signInBtn.addEventListener('click', async () => {
        try {
          await Clerk.redirectToSignIn({
            redirectUrl: '/dev/auth/'
          });
        } catch (err) {
          console.error("Failed to redirect to sign-in:", err);
          showNotification("Error starting sign-in process", "error");
        }
      });

      // Go to upload page
      uploadBtn.addEventListener('click', () => {
        if (!session) {
          showNotification("Please sign in first!", "error");
          return;
        }
        window.location.href = '/dev/upload/index.html';
      });

      // Sign out
      signOutBtn.addEventListener('click', async () => {
        if (session) {
          try {
            await Clerk.signOut({ redirectUrl: '/dev/' });
            showNotification("You have been signed out", "success");
          } catch (err) {
            console.error("Sign out error:", err);
            showNotification("Error signing out", "error");
          }
        } else {
          showNotification("You are not signed in", "info");
        }
      });
      
      
      // Function to show notifications
      function showNotification(message, type = 'info') {
        // Check if notification container exists, if not create it
        let notifContainer = document.getElementById('notification-container');
        if (!notifContainer) {
          notifContainer = document.createElement('div');
          notifContainer.id = 'notification-container';
          notifContainer.style.position = 'fixed';
          notifContainer.style.top = '20px';
          notifContainer.style.right = '20px';
          notifContainer.style.zIndex = '1000';
          document.body.appendChild(notifContainer);
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.style.backgroundColor = type === 'error' ? '#f8d7da' : 
                                           type === 'success' ? '#d4edda' : 
                                           '#cce5ff';
        notification.style.color = type === 'error' ? '#721c24' : 
                                 type === 'success' ? '#155724' : 
                                 '#004085';
        notification.style.padding = '10px 15px';
        notification.style.marginBottom = '10px';
        notification.style.borderRadius = '4px';
        notification.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
        notification.style.transition = 'all 0.3s ease';
        notification.textContent = message;
        
        // Add to container
        notifContainer.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.opacity = '0';
          setTimeout(() => {
            notifContainer.removeChild(notification);
          }, 300);
        }, 3000);
      }


      // Utility function to get cookie value
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }

      // Function to load videos from Typesense
      async function loadVideos() {
        try {
          
          let apiKey = getCookie('apikey');
          if (!apiKey) {
            console.log('No scoped API key found, requesting new one...');
            // Try to get a new scoped API key from /api/auth
            try {
              const token = await Clerk.session?.getToken();
              if (!token) {
                console.log('No session token, signing out user...');
                await Clerk.signOut({ redirectUrl: '/dev/' });
                return;
              }

              console.log('Making request to /api/auth...');
              const authResponse = await fetch('/api/auth', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                }
              });

              console.log('Auth response status:', authResponse.status);
              console.log('Auth response ok:', authResponse.ok);
              
              if (!authResponse.ok) {
                const errorText = await authResponse.text();
                console.log('Auth response error:', errorText);
                console.log('Failed to get scoped API key, signing out user...');
                await Clerk.signOut({ redirectUrl: '/dev/' });
                return;
              }
              
              const authData = await authResponse.json();
              console.log('Auth response data:', authData);
              console.log('Scoped key generated:', authData.scopedKeyGenerated);
              console.log('Environment variables:', authData.envVars);
              if (authData.typesenseError) {
                console.error('Typesense error:', authData.typesenseError);
              }

              // Check if apikey cookie was set
              apiKey = getCookie('apikey');
              if (!apiKey) {
                console.log('Scoped API key not set in cookie, signing out user...');
                await Clerk.signOut({ redirectUrl: '/dev/' });
                return;
              }
            } catch (error) {
              console.error('Error requesting scoped API key:', error);
              await Clerk.signOut({ redirectUrl: '/dev/' });
              return;
            }
          }

          // Initialize Typesense client with scoped API key (always run this)
          console.log('Initializing Typesense client with:', {
            host: CONFIG.TYPESENSE_HOST,
            apiKey: apiKey ? 'present' : 'missing'
          });
          
          if (typeof Typesense === 'undefined') {
            console.error('Typesense library not loaded');
            throw new Error('Typesense library not available');
          }
          
          typesenseClient = new Typesense.Client({
            nodes: [{
              host: CONFIG.TYPESENSE_HOST,
              port: 443,
              protocol: 'https'
            }],
            apiKey: apiKey,
            connectionTimeoutSeconds: 2
          });
          
          console.log('Typesense client initialized successfully');

          // Check if Typesense client was initialized successfully
          if (!typesenseClient) {
            console.error('Typesense client not initialized');
            document.getElementById('noVideos').style.display = 'block';
            return;
          }

          // Use Typesense client library to search videos
          const searchResults = await typesenseClient
            .collections('videos')
            .documents()
            .search({
              q: '*',
              query_by: 'title,description',
              per_page: 50,
              sort_by: 'created_at:desc'
            });

          displayVideos(searchResults.hits || []);
        } catch (error) {
          console.error('Error loading videos:', error);
          document.getElementById('noVideos').style.display = 'block';
        }
      }

      // Function to display videos in the grid
      function displayVideos(videos) {
        const videoGrid = document.getElementById('videoGrid');
        const noVideos = document.getElementById('noVideos');
        
        if (!videos || videos.length === 0) {
          noVideos.style.display = 'block';
          return;
        }

        noVideos.style.display = 'none';
        videoGrid.innerHTML = '';

        videos.forEach(video => {
          const videoCard = createVideoCard(video);
          videoGrid.appendChild(videoCard);
        });
      }

      // Function to create a video card element
      function createVideoCard(video) {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.dataset.videoId = video.id;

        const thumbnailUrl = video.thumbnail || '';
        const title = video.title || 'Untitled Video';
        const duration = video.duration || 'Unknown';
        const fileSize = video.file_size ? formatFileSize(video.file_size) : 'Unknown size';

        card.innerHTML = `
          <div class="video-thumbnail">
            ${thumbnailUrl ? `<img src="${thumbnailUrl}" alt="${title}" style="width: 100%; height: 100%; object-fit: cover;">` : 'No thumbnail'}
          </div>
          <div class="video-info">
            <div class="video-title">
              <span>${title}</span>
              <div class="video-actions">
                <button class="dropdown-btn" onclick="toggleDropdown('${video.id}')">⋮</button>
                <div class="dropdown-menu" id="dropdown-${video.id}">
                  <button class="dropdown-item" onclick="editVideo('${video.id}')">Edit</button>
                  <button class="dropdown-item danger" onclick="deleteVideo('${video.id}')">Delete</button>
                </div>
              </div>
            </div>
            <div class="video-meta">Duration: ${duration}</div>
            <div class="video-meta">Size: ${fileSize}</div>
          </div>
        `;

        return card;
      }

      // Function to format file size
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // Function to toggle dropdown menu
      window.toggleDropdown = function(videoId) {
        const dropdown = document.getElementById(`dropdown-${videoId}`);
        const isVisible = dropdown.classList.contains('show');
        
        // Close all dropdowns
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
          menu.classList.remove('show');
        });
        
        // Toggle current dropdown
        if (!isVisible) {
          dropdown.classList.add('show');
        }
      };

      // Function to edit video
      window.editVideo = function(videoId) {
        openVideoModal(videoId);
      };

      // Function to delete video
      window.deleteVideo = async function(videoId) {
        if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
          return;
        }

        try {
          const response = await fetch('/api/delete', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${await Clerk.session.getToken()}`
            },
            body: JSON.stringify({ id: videoId })
          });

          const result = await response.json();

          if (result.success) {
            showNotification('Video deleted successfully', 'success');
            
            // Remove video card from DOM
            const videoCard = document.querySelector(`[data-video-id="${videoId}"]`);
            if (videoCard) {
              videoCard.remove();
            }
            
            // Check if no videos left
            const remainingVideos = document.querySelectorAll('.video-card');
            if (remainingVideos.length === 0) {
              document.getElementById('noVideos').style.display = 'block';
            }
          } else {
            throw new Error(result.error || 'Failed to delete video');
          }
        } catch (error) {
          console.error('Failed to delete video:', error);
          showNotification('Failed to delete video', 'error');
        }
      };

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(event) {
        if (!event.target.closest('.video-actions')) {
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
          });
        }
      });

      // Modal functions
      let currentVideoData = null;

      // Function to open video modal
      window.openVideoModal = function(videoId) {
        // Find video data from the loaded videos
        const videoCard = document.querySelector(`[data-video-id="${videoId}"]`);
        if (!videoCard) {
          showNotification('Video not found', 'error');
          return;
        }

        // Get video data (in a real app, this would come from the search results)
        currentVideoData = {
          id: videoId,
          title: videoCard.querySelector('.video-title span').textContent,
          description: '',
          filename: videoId + '.mp4', // Placeholder
          thumbnail: ''
        };

        // Populate modal
        document.getElementById('videoTitle').value = currentVideoData.title;
        document.getElementById('videoDescription').value = currentVideoData.description;
        
        // Set video source (construct URL from filename)
        const videoElement = document.getElementById('videoElement');
        const videoSource = videoElement.querySelector('source');
        videoSource.src = `https://your-bucket.s3.amazonaws.com/${currentVideoData.filename}`;
        videoElement.load();

        // Reset thumbnail preview
        const thumbnailPreview = document.getElementById('thumbnailPreview');
        if (currentVideoData.thumbnail) {
          thumbnailPreview.innerHTML = `<img src="${currentVideoData.thumbnail}" alt="Thumbnail">`;
        } else {
          thumbnailPreview.innerHTML = '<span>Click to generate thumbnail</span>';
        }

        // Show modal
        document.getElementById('videoModal').style.display = 'block';
      };

      // Function to close video modal
      window.closeVideoModal = function() {
        document.getElementById('videoModal').style.display = 'none';
        const videoElement = document.getElementById('videoElement');
        videoElement.pause();
        currentVideoData = null;
      };

      // Function to generate thumbnail from video
      window.generateThumbnail = function() {
        const videoElement = document.getElementById('videoElement');
        if (videoElement.videoWidth === 0) {
          showNotification('Please wait for video to load', 'info');
          return;
        }

        // Create canvas to capture frame
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        
        // Draw current frame
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        
        // Convert to blob and display
        canvas.toBlob(function(blob) {
          const url = URL.createObjectURL(blob);
          const thumbnailPreview = document.getElementById('thumbnailPreview');
          thumbnailPreview.innerHTML = `<img src="${url}" alt="Generated thumbnail">`;
          
          // Store thumbnail data for upload
          currentVideoData.thumbnailBlob = blob;
          showNotification('Thumbnail generated successfully', 'success');
        }, 'image/jpeg', 0.8);
      };

      // Function to handle thumbnail file upload
      window.handleThumbnailUpload = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
          showNotification('Please select an image file', 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const thumbnailPreview = document.getElementById('thumbnailPreview');
          thumbnailPreview.innerHTML = `<img src="${e.target.result}" alt="Custom thumbnail">`;
          currentVideoData.thumbnailBlob = file;
          showNotification('Thumbnail uploaded successfully', 'success');
        };
        reader.readAsDataURL(file);
      };

      // Function to publish video (update details)
      window.publishVideo = async function() {
        if (!currentVideoData) return;

        const title = document.getElementById('videoTitle').value.trim();
        const description = document.getElementById('videoDescription').value.trim();

        if (!title) {
          showNotification('Please enter a title', 'error');
          return;
        }

        try {
          const updateData = {
            id: currentVideoData.id,
            title: title,
            description: description
          };

          // If thumbnail was generated/uploaded, include it
          if (currentVideoData.thumbnailBlob) {
            // In a real implementation, you'd upload the thumbnail to storage first
            // For now, we'll just include a placeholder
            updateData.thumbnail = 'thumbnail-url-placeholder';
          }

          const response = await fetch('/api/update', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${await Clerk.session.getToken()}`
            },
            body: JSON.stringify(updateData)
          });

          const result = await response.json();

          if (result.success) {
            showNotification('Video details updated successfully', 'success');
            closeVideoModal();
            
            // Update the video card in the grid
            const videoCard = document.querySelector(`[data-video-id="${currentVideoData.id}"]`);
            if (videoCard) {
              const titleElement = videoCard.querySelector('.video-title span');
              titleElement.textContent = title;
            }
          } else {
            throw new Error(result.error || 'Failed to update video');
          }
        } catch (error) {
          console.error('Failed to update video:', error);
          showNotification('Failed to update video details', 'error');
        }
      };

      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('videoModal');
        if (event.target === modal) {
          closeVideoModal();
        }
      };

      // Check for video ID in URL on page load
      const urlParams = new URLSearchParams(window.location.search);
      const videoId = urlParams.get('v');
      if (videoId && session) {
        // Wait a bit for videos to load, then open modal
        setTimeout(() => {
          openVideoModal(videoId);
        }, 1000);
      }

    } catch (error) {
      console.error('Dashboard initialization error:', error);
      document.getElementById('greeting').textContent = 'Error loading dashboard. Please try again later.';
    }
  })
  </script>
</body>
</html>